#!/usr/bin/env bash
project_dir="$( cd "$( dirname "${BASH_SOURCE[0]}" )"/.. && pwd )"

computer_name=$1
shift

export NIX_PATH=nixpkgs=$project_dir/nixpkgs
export NIX_PATH=$NIX_PATH:nixos=$project_dir/nixpkgs/nixos
export NIX_PATH=$NIX_PATH:nixos-config=$project_dir/computers/$computer_name/configuration.nix
export NIX_PATH="${NIX_PATH}:nixpkgs-overlays=${project_dir}/nixpkgs-config/overlays"

set -e

nix-build --show-trace '<nixpkgs/nixos>' -o ${computer_name}-system -A system

exec nixos-rebuild boot --keep-failed --build-host localhost --target-host $computer_name --use-remote-sudo "$@"
